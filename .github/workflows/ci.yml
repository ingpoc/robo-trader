name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  CACHE_VERSION: v1

jobs:
  # ============================================================================
  # CODE QUALITY & LINTING
  # ============================================================================

  lint-python:
    name: Python Linting & Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort mypy pytest
          pip install -r requirements.txt

      - name: Check code formatting with black
        run: black --check --diff src/ tests/ || echo "::warning::Code is not formatted with black"

      - name: Check import sorting with isort
        run: isort --check-only --diff src/ tests/ || echo "::warning::Imports are not sorted correctly"

      - name: Lint with ruff
        run: ruff check src/ tests/ --output-format=github

      - name: Type checking with mypy
        run: mypy src/ --install-types --non-interactive --ignore-missing-imports || echo "::warning::Type checking found issues"

  lint-frontend:
    name: Frontend Linting & Type Checking
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ui
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Type check with TypeScript
        run: npx tsc --noEmit

  # ============================================================================
  # TESTING
  # ============================================================================

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: robo_trader_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pytest-mock
          pip install -r requirements.txt

      - name: Set environment variables
        run: |
          echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/robo_trader_test" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379/0" >> $GITHUB_ENV
          echo "ENVIRONMENT=testing" >> $GITHUB_ENV

      - name: Run database migrations
        run: python -m src.setup || echo "Setup completed"

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=term \
            --cov-report=html \
            --cov-fail-under=70 \
            -v \
            --tb=short

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v5
        if: matrix.python-version == '3.11'
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 7

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          flags: backend
          name: backend-coverage
        continue-on-error: true

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ui
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build frontend
        run: npm run build

      - name: Run Playwright tests
        run: npx playwright test
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: playwright-report
          path: ui/playwright-report/
          retention-days: 7

  # ============================================================================
  # BUILD VALIDATION
  # ============================================================================

  build-docker:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: robo-trader:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/robo-trader-image.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v5
        with:
          name: docker-image
          path: /tmp/robo-trader-image.tar
          retention-days: 1

      - name: Test Docker image
        run: |
          docker load --input /tmp/robo-trader-image.tar
          docker run --rm -d \
            --name robo-trader-test \
            -e ENVIRONMENT=testing \
            -e DATABASE_URL=sqlite:///tmp/test.db \
            robo-trader:test

          # Wait for container to start
          sleep 10

          # Check if container is still running
          if docker ps | grep robo-trader-test; then
            echo "‚úÖ Container started successfully"
            docker logs robo-trader-test
            docker stop robo-trader-test
          else
            echo "‚ùå Container failed to start"
            docker logs robo-trader-test
            exit 1
          fi

  build-frontend:
    name: Frontend Build Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ui
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build production bundle
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check bundle size
        run: |
          if [ -d "dist" ]; then
            BUNDLE_SIZE=$(du -sh dist | cut -f1)
            echo "üì¶ Bundle size: $BUNDLE_SIZE"

            # Get size in MB
            SIZE_MB=$(du -sm dist | cut -f1)
            if [ "$SIZE_MB" -gt 10 ]; then
              echo "::warning::Bundle size ($BUNDLE_SIZE) exceeds 10MB. Consider optimization."
            fi
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: frontend-dist
          path: ui/dist/
          retention-days: 7

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, build-docker]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: robo_trader_integration
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/robo-trader-image.tar

      - name: Start application container
        run: |
          docker run -d \
            --name robo-trader-app \
            --network host \
            -e DATABASE_URL=postgresql://test_user:test_password@localhost:5432/robo_trader_integration \
            -e REDIS_URL=redis://localhost:6379/0 \
            -e ENVIRONMENT=testing \
            robo-trader:test

      - name: Wait for application to be ready
        run: |
          timeout 60s bash -c 'until curl -f http://localhost:8000/api/health; do sleep 2; done' || {
            echo "Application failed to start"
            docker logs robo-trader-app
            exit 1
          }

      - name: Run API health checks
        run: |
          # Health endpoint
          curl -f http://localhost:8000/api/health || exit 1

          # Test API endpoints (add more as needed)
          echo "‚úÖ Health check passed"

      - name: Collect logs on failure
        if: failure()
        run: |
          docker logs robo-trader-app > app-logs.txt
          cat app-logs.txt

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: integration-test-logs
          path: app-logs.txt

      - name: Cleanup
        if: always()
        run: docker stop robo-trader-app || true

  # ============================================================================
  # STATUS CHECK
  # ============================================================================

  ci-status:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs:
      - lint-python
      - lint-frontend
      - test-backend
      - test-frontend
      - build-docker
      - build-frontend
      - integration-test
    if: always()
    steps:
      - name: Check CI results
        run: |
          if [ "${{ needs.lint-python.result }}" != "success" ] || \
             [ "${{ needs.lint-frontend.result }}" != "success" ] || \
             [ "${{ needs.test-backend.result }}" != "success" ] || \
             [ "${{ needs.test-frontend.result }}" != "success" ] || \
             [ "${{ needs.build-docker.result }}" != "success" ] || \
             [ "${{ needs.build-frontend.result }}" != "success" ] || \
             [ "${{ needs.integration-test.result }}" != "success" ]; then
            echo "‚ùå CI pipeline failed"
            exit 1
          else
            echo "‚úÖ All CI checks passed"
          fi
